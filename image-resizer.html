<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Resizer | Watermark & Filter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-light: #f1f5f9; --bg-dark: #0f172a;
            --card-light: #ffffff; --card-dark: #1e293b;
            --text-light: #0f172a; --text-dark: #e2e8f0;
            --text-muted-light: #64748b; --text-muted-dark: #94a3b8;
            --border-light: #e2e8f0; --border-dark: #334155;
            --primary: #4f46e5; --primary-hover: #4338ca;
            --secondary: #10b981; --secondary-hover: #059669;
        }
        html.dark { --bg: var(--bg-dark); --card: var(--card-dark); --text: var(--text-dark); --text-muted: var(--text-muted-dark); --border: var(--border-dark); }
        html:not(.dark) { --bg: var(--bg-light); --card: var(--card-light); --text: var(--text-light); --text-muted: var(--text-muted-light); --border: var(--border-light); }
        
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); transition: background-color 0.3s, color 0.3s; }
        .card { background-color: var(--card); transition: background-color 0.3s; }
        .text-muted { color: var(--text-muted); }
        .border-color { border-color: var(--border); }
        .input-field { background-color: var(--bg); border: 1px solid var(--border); color: var(--text); }
        .input-field:focus { border-color: var(--primary); outline: 2px solid transparent; outline-offset: 2px; box-shadow: 0 0 0 2px var(--primary); }
        
        .drop-zone { border: 2px dashed var(--border); transition: all 0.2s ease-in-out; }
        .drop-zone.dragover { background-color: rgba(79, 70, 229, 0.1); border-color: var(--primary); }
        
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.75rem 1.25rem; font-weight: 600; border-radius: 0.5rem; transition: all 0.2s; white-space: nowrap; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-secondary { background-color: var(--secondary); color: white; }
        .btn-secondary:hover { background-color: var(--secondary-hover); }
        .btn-tertiary { background-color: var(--bg); color: var(--text); border: 1px solid var(--border); }
        .btn-tertiary:hover { background-color: rgba(100, 116, 139, 0.1); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Accordion */
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; }
        .accordion-header.active + .accordion-content { max-height: 500px; }
        .accordion-header .icon { transition: transform 0.3s; }
        .accordion-header.active .icon { transform: rotate(180deg); }

        /* Comparison Slider */
        .comparison-slider { position: relative; overflow: hidden; }
        .comparison-slider img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; }
        .comparison-slider .img-resized { clip-path: inset(0 50% 0 0); }
        .comparison-slider .slider-handle { position: absolute; top: 0; bottom: 0; left: 50%; width: 4px; background-color: rgba(255, 255, 255, 0.8); cursor: ew-resize; transform: translateX(-50%); }
        .comparison-slider .slider-handle::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 40px; height: 40px; border: 2px solid white; border-radius: 50%; background: var(--primary) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41zM16 6h2v12h-2zM6 6h2v12H6z"/></svg>') center no-repeat; background-size: 20px; box-shadow: 0 0 15px rgba(0,0,0,0.5); }
    </style>
</head>
<body class="flex items-center justify-center min-h-full p-4 antialiased">

    <div class="fixed top-6 right-6 z-50">
        <button id="theme-toggle" class="p-2 rounded-full btn-tertiary">
            <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
            <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
        </button>
    </div>

    <div class="w-full max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-extrabold">Ultimate Resizer</h1>
            <p class="text-muted mt-3 text-lg">Resize, Filter, and Watermark Your Images Like a Pro.</p>
        </header>

        <div id="app-container" class="card rounded-2xl shadow-2xl p-4 md:p-8 min-h-[600px] flex flex-col">

            <!-- Uploader View -->
            <div id="uploader-view" class="flex flex-col flex-grow justify-center items-center">
                <label for="file-upload" class="w-full max-w-2xl cursor-pointer">
                    <div id="drop-zone" class="drop-zone rounded-xl p-8 text-center">
                        <div class="flex flex-col items-center justify-center space-y-4 text-muted">
                             <svg class="w-16 h-16 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3 3m3-3l3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" /></svg>
                            <p class="text-xl font-semibold text-text">
                                <span class="text-primary">Upload files</span> or drag and drop
                            </p>
                            <p>Supports Batch Processing, PNG, JPG, WEBP</p>
                        </div>
                    </div>
                </label>
                <input id="file-upload" type="file" class="hidden" accept="image/png, image/jpeg, image/webp" multiple>
            </div>

            <!-- Editor View -->
            <div id="editor-view" class="hidden flex-grow">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 h-full">
                    
                    <!-- Left Panel: Settings -->
                    <div class="lg:col-span-4 flex flex-col">
                        <h2 class="text-2xl font-bold mb-6">Settings</h2>
                        <div class="space-y-2">
                            <!-- Resize & Format Section -->
                            <div class="border border-color rounded-lg">
                                <button class="accordion-header w-full flex justify-between items-center p-3 font-semibold">
                                    <span>Resize & Format</span>
                                    <svg class="icon w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                                </button>
                                <div class="accordion-content p-4 pt-0 space-y-4">
                                    <select id="preset-select" class="w-full input-field rounded-md p-2">
                                        <option value="custom">Custom Dimensions</option>
                                        <option value="1080,1080">Instagram Post (1080x1080)</option>
                                        <option value="1080,1920">Instagram Story (1080x1920)</option>
                                    </select>
                                    <div class="grid grid-cols-2 gap-4">
                                        <input type="number" id="width-input" placeholder="Width" class="w-full input-field rounded-md p-2">
                                        <input type="number" id="height-input" placeholder="Height" class="w-full input-field rounded-md p-2">
                                    </div>
                                    <div class="flex items-center"><input id="aspect-ratio-lock" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary" checked><label for="aspect-ratio-lock" class="ml-2 block text-sm">Maintain aspect ratio</label></div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <select id="format-select" class="w-full input-field rounded-md p-2"><option value="image/png">PNG</option><option value="image/jpeg">JPG</option><option value="image/webp">WEBP</option></select>
                                        <div id="quality-container"><input type="range" id="quality-slider" min="10" max="100" value="90" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mt-2 accent-primary"><label class="text-xs text-muted">Quality: <span id="quality-value">90</span>%</label></div>
                                    </div>
                                </div>
                            </div>
                            <!-- Filters Section -->
                            <div class="border border-color rounded-lg">
                                <button class="accordion-header w-full flex justify-between items-center p-3 font-semibold"><span>Filters</span><svg class="icon w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></button>
                                <div class="accordion-content p-4 pt-0">
                                    <select id="filter-select" class="w-full input-field rounded-md p-2">
                                        <option value="none">None</option><option value="grayscale(100%)">Grayscale</option><option value="sepia(100%)">Sepia</option><option value="invert(100%)">Invert</option>
                                    </select>
                                </div>
                            </div>
                            <!-- Watermark Section -->
                            <div class="border border-color rounded-lg">
                                <button class="accordion-header w-full flex justify-between items-center p-3 font-semibold"><span>Watermark</span><svg class="icon w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></button>
                                <div class="accordion-content p-4 pt-0 space-y-4">
                                    <div class="flex items-center"><input id="watermark-enabled" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary"><label for="watermark-enabled" class="ml-2 block text-sm">Enable Watermark</label></div>
                                    <div id="watermark-options" class="hidden space-y-4">
                                        <input type="text" id="watermark-text" placeholder="Your Text" class="w-full input-field rounded-md p-2">
                                        <div class="grid grid-cols-2 gap-4">
                                            <input type="number" id="watermark-size" placeholder="Size (px)" value="48" class="w-full input-field rounded-md p-2">
                                            <input type="color" id="watermark-color" value="#ffffff" class="w-full input-field rounded-md p-1 h-10">
                                        </div>
                                        <div><label class="text-xs text-muted">Opacity</label><input type="range" id="watermark-opacity" min="0" max="1" step="0.1" value="0.7" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mt-1 accent-primary"></div>
                                        <select id="watermark-position" class="w-full input-field rounded-md p-2">
                                            <option value="center">Center</option><option value="bottom-right">Bottom Right</option><option value="bottom-left">Bottom Left</option><option value="top-right">Top Right</option><option value="top-left">Top Left</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-8">
                             <button id="process-btn" class="btn btn-primary w-full text-base">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 15l.813-.904m-2.826.904L6 15l.813-.904m2.826.904L9 16.813l-.813-.904m2.826 0l.813.904L12 15l-.813-.904M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                Process <span id="file-count"></span> Image(s)
                            </button>
                        </div>
                        <div class="mt-auto pt-6">
                            <button id="reset-btn" class="btn btn-tertiary w-full">Start Over</button>
                        </div>
                    </div>
                    
                    <!-- Right Panel: Results -->
                    <div class="lg:col-span-8 flex flex-col">
                        <div id="result-placeholder" class="flex-grow flex flex-col items-center justify-center border-2 border-dashed border-color rounded-lg p-8 text-center text-muted">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            <h3 class="text-xl font-semibold text-text">Your processed images will appear here</h3>
                            <p class="mt-2">Adjust settings and click "Process".</p>
                        </div>
                        <div id="result-view" class="hidden flex-grow flex flex-col">
                             <div id="comparison-container" class="w-full h-80 bg-slate-100 dark:bg-slate-800 rounded-lg relative comparison-slider mb-4">
                                <img id="img-original" src="#" alt="Original"><img id="img-processed" src="#" alt="Processed" class="img-resized"><div id="slider-handle" class="slider-handle"></div>
                            </div>
                            <div id="result-info" class="text-center text-sm text-muted mb-4"></div>
                            <div class="flex flex-col sm:flex-row gap-3">
                                <button id="download-all-btn" class="btn btn-secondary w-full">Download All (.zip)</button>
                                <button id="copy-btn" class="btn btn-tertiary w-full">Copy Image</button>
                            </div>
                            <div id="image-list" class="mt-4 space-y-2 overflow-y-auto max-h-48 pr-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const getEl = (id) => document.getElementById(id);
    // DOM Elements
    const uploaderView = getEl('uploader-view'), editorView = getEl('editor-view'), fileInput = getEl('file-upload'),
        dropZone = getEl('drop-zone'), widthInput = getEl('width-input'), heightInput = getEl('height-input'),
        aspectRatioLock = getEl('aspect-ratio-lock'), formatSelect = getEl('format-select'),
        qualityContainer = getEl('quality-container'), qualitySlider = getEl('quality-slider'),
        qualityValue = getEl('quality-value'), presetSelect = getEl('preset-select'), processBtn = getEl('process-btn'),
        fileCount = getEl('file-count'), resetBtn = getEl('reset-btn'), resultPlaceholder = getEl('result-placeholder'),
        resultView = getEl('result-view'), resultInfo = getEl('result-info'), downloadAllBtn = getEl('download-all-btn'),
        copyBtn = getEl('copy-btn'), imageList = getEl('image-list'), themeToggle = getEl('theme-toggle'),
        themeIconLight = getEl('theme-icon-light'), themeIconDark = getEl('theme-icon-dark'),
        comparisonContainer = getEl('comparison-container'), imgOriginal = getEl('img-original'),
        imgProcessed = getEl('img-processed'), sliderHandle = getEl('slider-handle'),
        filterSelect = getEl('filter-select'), watermarkEnabled = getEl('watermark-enabled'),
        watermarkOptions = getEl('watermark-options'), watermarkText = getEl('watermark-text'),
        watermarkSize = getEl('watermark-size'), watermarkColor = getEl('watermark-color'),
        watermarkOpacity = getEl('watermark-opacity'), watermarkPosition = getEl('watermark-position');

    // App State
    let files = [], processedBlobs = [], activeFileIndex = 0;

    // --- Theme ---
    const applyTheme = (isDark) => {
        document.documentElement.classList.toggle('dark', isDark);
        themeIconLight.classList.toggle('hidden', isDark);
        themeIconDark.classList.toggle('hidden', !isDark);
    };
    themeToggle.addEventListener('click', () => {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        applyTheme(isDark);
    });

    // --- File Handling ---
    const handleFiles = (fileList) => {
        files = Array.from(fileList).filter(f => f.type.startsWith('image/'));
        if (files.length === 0) return;
        activeFileIndex = 0;
        processedBlobs = new Array(files.length);
        uploaderView.classList.add('hidden');
        editorView.classList.remove('hidden');
        resultPlaceholder.classList.remove('hidden');
        resultView.classList.add('hidden');
        fileCount.textContent = files.length;
        updateDimensionInputsWithImage(files[0]);
        updateImageList();
    };

    const updateDimensionInputsWithImage = (file) => {
        const reader = new FileReader();
        reader.onload = e => {
            const img = new Image();
            img.onload = () => { widthInput.value = img.width; heightInput.value = img.height; };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    };

    const updateImageList = () => {
        imageList.innerHTML = '';
        files.forEach((file, index) => {
            const li = document.createElement('li');
            li.className = `p-2 rounded-md flex items-center justify-between cursor-pointer border-2 ${index === activeFileIndex ? 'border-primary' : 'border-transparent'} hover:bg-slate-100 dark:hover:bg-slate-700`;
            li.innerHTML = `<span class="text-sm truncate">${file.name}</span><span id="status-${index}" class="text-xs text-muted">Pending</span>`;
            li.addEventListener('click', () => {
                activeFileIndex = index;
                updateDimensionInputsWithImage(files[index]);
                updateImageList();
                updateComparisonView();
            });
            imageList.appendChild(li);
        });
    };

    // --- Image Processing ---
    const processAllImages = async () => {
        processBtn.disabled = true;
        processBtn.innerHTML = 'Processing...';
        for (let i = 0; i < files.length; i++) {
            const statusEl = getEl(`status-${i}`);
            statusEl.textContent = 'Processing...';
            statusEl.className = 'text-xs text-yellow-500';
            try {
                processedBlobs[i] = await processImage(files[i]);
                statusEl.textContent = `Done (${formatBytes(processedBlobs[i].size)})`;
                statusEl.className = 'text-xs text-green-500';
            } catch (error) {
                console.error(`Error processing ${files[i].name}:`, error);
                statusEl.textContent = 'Error';
                statusEl.className = 'text-xs text-red-500';
            }
        }
        processBtn.disabled = false;
        processBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 15l.813-.904m-2.826.904L6 15l.813-.904m2.826.904L9 16.813l-.813-.904m2.826 0l.813.904L12 15l-.813-.904M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Process ${files.length} Image(s)`;
        resultPlaceholder.classList.add('hidden');
        resultView.classList.remove('hidden');
        updateComparisonView();
    };

    const processImage = (file) => new Promise((resolve, reject) => {
        const newWidth = parseInt(widthInput.value), newHeight = parseInt(heightInput.value);
        if (!newWidth || !newHeight || newWidth <= 0 || newHeight <= 0) return reject(new Error('Invalid dimensions'));
        
        const reader = new FileReader();
        reader.onload = e => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = newWidth;
                canvas.height = newHeight;
                const ctx = canvas.getContext('2d');
                
                // Apply Filter
                if (filterSelect.value !== 'none') ctx.filter = filterSelect.value;
                ctx.drawImage(img, 0, 0, newWidth, newHeight);
                ctx.filter = 'none'; // Reset filter for watermark

                // Apply Watermark
                if (watermarkEnabled.checked && watermarkText.value) {
                    const size = parseInt(watermarkSize.value);
                    ctx.font = `bold ${size}px Arial`;
                    ctx.fillStyle = watermarkColor.value;
                    ctx.globalAlpha = parseFloat(watermarkOpacity.value);
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    const text = watermarkText.value;
                    const padding = size * 0.5;
                    let x, y;
                    switch(watermarkPosition.value) {
                        case 'bottom-right': x = newWidth - ctx.measureText(text).width / 2 - padding; y = newHeight - size / 2 - padding; break;
                        case 'bottom-left': x = ctx.measureText(text).width / 2 + padding; y = newHeight - size / 2 - padding; break;
                        case 'top-right': x = newWidth - ctx.measureText(text).width / 2 - padding; y = size / 2 + padding; break;
                        case 'top-left': x = ctx.measureText(text).width / 2 + padding; y = size / 2 + padding; break;
                        default: x = newWidth / 2; y = newHeight / 2; // Center
                    }
                    ctx.fillText(text, x, y);
                    ctx.globalAlpha = 1.0;
                }
                
                canvas.toBlob(blob => resolve(blob), formatSelect.value, parseInt(qualitySlider.value) / 100);
            };
            img.onerror = reject;
            img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });

    // --- UI & Actions ---
    const updateComparisonView = () => {
        if (files[activeFileIndex] && processedBlobs[activeFileIndex]) {
            imgOriginal.src = URL.createObjectURL(files[activeFileIndex]);
            imgProcessed.src = URL.createObjectURL(processedBlobs[activeFileIndex]);
            const originalSize = formatBytes(files[activeFileIndex].size);
            const newSize = formatBytes(processedBlobs[activeFileIndex].size);
            resultInfo.textContent = `Original: ${originalSize} → Processed: ${newSize}`;
        }
    };
    
    const downloadAll = () => {
        const zip = new JSZip();
        let downloadCount = 0;
        processedBlobs.forEach((blob, index) => {
            if (blob) {
                const file = files[index], extension = formatSelect.value.split('/')[1];
                const baseName = file.name.substring(0, file.name.lastIndexOf('.'));
                zip.file(`${baseName}-${widthInput.value}x${heightInput.value}.${extension}`, blob);
                downloadCount++;
            }
        });
        if(downloadCount === 0) return alert("No images processed yet.");
        zip.generateAsync({ type: "blob" }).then(content => {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = "processed-images.zip";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    };

    const copyActiveImage = async () => {
        const blob = processedBlobs[activeFileIndex];
        if (!blob || !navigator.clipboard?.write) return alert('Image not processed or copy not supported.');
        try {
            await navigator.clipboard.write([ new ClipboardItem({ [blob.type]: blob }) ]);
            const originalText = copyBtn.textContent;
            copyBtn.textContent = 'Copied!';
            setTimeout(() => { copyBtn.textContent = originalText; }, 2000);
        } catch (error) { console.error('Failed to copy image:', error); alert('Failed to copy image.'); }
    };
    
    const resetApp = () => {
        files = []; processedBlobs = [];
        uploaderView.classList.remove('hidden');
        editorView.classList.add('hidden');
        fileInput.value = '';
    };
    
    // --- Event Listeners ---
    fileInput.addEventListener('change', e => handleFiles(e.target.files));
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
    
    processBtn.addEventListener('click', processAllImages);
    downloadAllBtn.addEventListener('click', downloadAll);
    copyBtn.addEventListener('click', copyActiveImage);
    resetBtn.addEventListener('click', resetApp);

    presetSelect.addEventListener('change', e => {
        if (e.target.value === 'custom') return;
        const [width, height] = e.target.value.split(',').map(Number);
        widthInput.value = width; heightInput.value = height;
    });
    
    const syncAspectRatio = (isWidth) => {
        if (aspectRatioLock.checked && files.length > 0) {
            const img = new Image();
            img.onload = () => {
                const ratio = img.width / img.height;
                if (isWidth) heightInput.value = Math.round(widthInput.value / ratio);
                else widthInput.value = Math.round(heightInput.value * ratio);
            };
            img.src = URL.createObjectURL(files[activeFileIndex]);
        }
    };
    widthInput.addEventListener('input', () => syncAspectRatio(true));
    heightInput.addEventListener('input', () => syncAspectRatio(false));

    formatSelect.addEventListener('change', () => qualityContainer.style.display = ['image/jpeg', 'image/webp'].includes(formatSelect.value) ? 'block' : 'none');
    qualitySlider.addEventListener('input', () => qualityValue.textContent = qualitySlider.value);
    
    watermarkEnabled.addEventListener('change', () => watermarkOptions.classList.toggle('hidden', !watermarkEnabled.checked));

    document.querySelectorAll('.accordion-header').forEach(header => {
        header.addEventListener('click', () => {
            header.classList.toggle('active');
        });
        // Auto-open first accordion
        if(header.parentElement === header.parentElement.parentElement.firstElementChild) header.classList.add('active');
    });

    // --- Comparison Slider ---
    let isDragging = false;
    const onDrag = (e) => {
        if (!isDragging) return;
        const rect = comparisonContainer.getBoundingClientRect();
        let offsetX = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        let percent = Math.max(0, Math.min(100, (offsetX / rect.width) * 100));
        sliderHandle.style.left = `${percent}%`;
        imgProcessed.style.clipPath = `inset(0 ${100 - percent}% 0 0)`;
    };
    sliderHandle.addEventListener('mousedown', () => isDragging = true);
    sliderHandle.addEventListener('touchstart', () => isDragging = true);
    window.addEventListener('mouseup', () => isDragging = false);
    window.addEventListener('touchend', () => isDragging = false);
    window.addEventListener('mousemove', onDrag);
    window.addEventListener('touchmove', onDrag);

    // --- Init ---
    const formatBytes = (b,d=2)=>(b===0)?'0 Bytes':(d=d<0?0:d,k=1024,i=Math.floor(Math.log(b)/Math.log(k)),`${parseFloat((b/Math.pow(k,i)).toFixed(d))} ${['Bytes','KB','MB','GB'][i]}`);
    const savedTheme = localStorage.getItem('theme');
    applyTheme(savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches));
    formatSelect.dispatchEvent(new Event('change'));
});
</script>
</body>
</html>
